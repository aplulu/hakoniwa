# Default values for hakoniwa.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

replicaCount: 1

image:
  repository: ghcr.io/aplulu/hakoniwa
  pullPolicy: IfNotPresent
  # Overrides the image tag whose default is the chart appVersion.
  tag: ""

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  # Specifies whether a service account should be created
  create: true
  # Annotations to add to the service account
  annotations: {}
  # The name of the service account to use.
  # If not set and create is true, a name is generated using the fullname template
  name: ""
  automountServiceAccountToken: true

podAnnotations: {}

podSecurityContext: {}
  # fsGroup: 2000

securityContext: {}
  # capabilities:
  #   drop:
  #   - ALL
  # readOnlyRootFilesystem: true
  # runAsNonRoot: true
  # runAsUser: 1000

service:
  type: ClusterIP
  port: 8080

ingress:
  enabled: false
  className: ""
  annotations: {}
    # kubernetes.io/ingress.class: nginx
    # kubernetes.io/tls-acme: "true"
  hosts:
    - host: hakoniwa.local
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: chart-example-tls
  #    hosts:
  #      - chart-example.local

resources:
  limits:
    cpu: 500m
    memory: 256Mi
  requests:
    cpu: 100m
    memory: 128Mi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 5
  targetCPUUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}

# Application Configuration
config:
  listen: ""
  port: "8080"
  kubernetesNamespace: "" # Defaults to the pod's namespace if empty
  swaggerUiEnabled: true
  instanceInactivityTimeout: "1m"
  maxPodCount: 100
  maxInstancesPerUser: 2
  maxInstancesPerUserPerType: 1
  enablePersistence: true
  title: "Hakoniwa"
  message: "On-Demand Cloud Workspace Environment"
  logoUrl: "/_hakoniwa/img/hakoniwa_logo.webp"
  termsOfServiceUrl: ""
  privacyPolicyUrl: ""
  authMethods: "anonymous" # Comma-separated list
  authAutoLogin: false
  jwtSecret: "" # If empty, it will be auto-generated
  sessionExpiration: "24h"
  
  # OIDC Configuration
  oidc:
    issuerUrl: ""
    clientId: ""
    clientSecret: ""
    redirectUrl: ""
    name: "OpenID Connect"
    scopes: "openid,profile"

# Pod Template Configuration
podTemplate:
  # This content will be mounted to /etc/hakoniwa/pod_template.yaml
  content: |
    apiVersion: v1
    kind: Pod
    metadata:
      name: webtop
      labels:
        app.kubernetes.io/name: hakoniwa-webtop
      annotations:
        hakoniwa.aplulu.me/display-name: "Webtop"
        hakoniwa.aplulu.me/description: "Full-featured Linux desktop environment."
        hakoniwa.aplulu.me/image-url: "/_hakoniwa/img/webtop.avif"
        hakoniwa.aplulu.me/port: "3000"
        hakoniwa.aplulu.me/persistable: "true"
    spec:
      containers:
        - name: desktop
          image: lscr.io/linuxserver/webtop:latest
          imagePullPolicy: IfNotPresent
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: DISABLE_SUDO
              value: "true"
          ports:
            - containerPort: 3000
              name: http
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
      restartPolicy: Never
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: code-server
      labels:
        app.kubernetes.io/name: code-server
      annotations:
        hakoniwa.aplulu.me/display-name: "Code-Server"
        hakoniwa.aplulu.me/description: "VS Code environment running in your browser."
        hakoniwa.aplulu.me/image-url: "/_hakoniwa/img/code-server.avif"
        hakoniwa.aplulu.me/port: "8080"
        hakoniwa.aplulu.me/persistable: "true"
        hakoniwa.aplulu.me/volume-path: "/home/coder/project"
    spec:
      containers:
        - name: code-server
          image: codercom/code-server:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
              name: http
          livenessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          volumeMounts:
            - name: workspace
              mountPath: /home/coder/project
          args:
            - "--auth=none"
            - "--bind-addr=0.0.0.0:8080"
      volumes:
        - name: workspace
          emptyDir: {}
    ---
    apiVersion: v1
    kind: Pod
    metadata:
      name: jupyter-notebook
      labels:
        app.kubernetes.io/name: jupyter-notebook
      annotations:
        hakoniwa.aplulu.me/display-name: "Jupyter Notebook"
        hakoniwa.aplulu.me/description: "Interactive environment for data analysis and machine learning."
        hakoniwa.aplulu.me/image-url: "/_hakoniwa/img/jupyter-notebook.avif"
        hakoniwa.aplulu.me/port: "8888"
        hakoniwa.aplulu.me/persistable: "true"
        hakoniwa.aplulu.me/volume-path: "/home/jovyan/work"
    spec:
      containers:
        - name: jupyter
          image: jupyter/base-notebook:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8888
              name: http
          livenessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /
              port: http
            initialDelaySeconds: 5
            periodSeconds: 10
          args:
            - start-notebook.sh
            - --NotebookApp.ip=0.0.0.0
            - --NotebookApp.port=8888
            - --NotebookApp.token=''
          resources:
            requests:
              cpu: "250m"
              memory: "512Mi"
            limits:
              cpu: "1"
              memory: "2Gi"
          volumeMounts:
            - name: work
              mountPath: /home/jovyan/work
      volumes:
        - name: work
          emptyDir: {}
